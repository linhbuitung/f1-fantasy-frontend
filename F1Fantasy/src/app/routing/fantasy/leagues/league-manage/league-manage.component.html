<app-content-container>
  <div class="d-flex justify-content-start mb-3">
    <button class="btn btn-outline-primary btn-back" routerLink="/fantasy/leagues">
      <i class="fa-solid fa-arrow-left"></i>
      Return
    </button>
  </div>
  <div class="league-manage-grid">
    <div class="league-manage-left">
      <h2 class="mb-4">Manage League</h2>
      <!-- League Info & Update Form -->
      <div *ngIf="league" class="card league-info-card mb-4">
        <div class="card-header bg-primary-red text-white">
          League Info
        </div>
        <div class="card-body">
          <form [formGroup]="updateForm" (ngSubmit)="onUpdate()">
            <div class="form-group row mb-2">
              <label class="col-sm-4 col-form-label">League Name</label>
              <div class="col-sm-8">
                <input type="text" formControlName="name" class="form-control" maxlength="200" />
              </div>
              <div *ngIf="updateForm.controls['name'].invalid && (updateForm.controls['name'].touched || updateForm.controls['name'].dirty)" class="alert alert-danger mt-1">
                <div *ngIf="updateForm.controls['name'].errors?.['required']">League name is required.</div>
                <div *ngIf="updateForm.controls['name'].errors?.['maxlength']">League name is too long.</div>
              </div>
            </div>
            <div class="form-group row mb-2">
              <label class="col-sm-4 col-form-label">Description</label>
              <div class="col-sm-8">
                <textarea formControlName="description" class="form-control" maxlength="500" rows="2"></textarea>
              </div>
              <div *ngIf="updateForm.controls['description'].invalid && (updateForm.controls['description'].touched || updateForm.controls['description'].dirty)" class="alert alert-danger mt-1">
                <div *ngIf="updateForm.controls['description'].errors?.['maxlength']">Description is too long.</div>
              </div>
            </div>
            <div class="form-group row mb-2">
              <label class="col-sm-4 col-form-label">Max Players</label>
              <div class="col-sm-8 d-flex align-items-center">
                <span class="form-control-plaintext">{{ league?.maxPlayersNum || 'N/A' }}</span>
              </div>
            </div>
            <div class="btn-section">
              <button type="submit" class="btn btn-primary-red btn-update" [disabled]="updateForm.invalid || submitting">
                {{ submitting ? 'Updating...' : 'Update League' }}
              </button>

              <button
                type="button"
                class="btn btn-outline-danger btn-delete"
                (click)="showDeleteConfirm = true"
              >
                <i class="fa-solid fa-trash"></i>
                Delete League
              </button>
            </div>
          </form>
          <div *ngIf="serverError" class="alert alert-danger mt-2">{{ serverError }}</div>
          <div *ngIf="successMessage" class="alert alert-success mt-2">{{ successMessage }}</div>
        </div>
      </div>

      <!-- Join Requests -->
      <div *ngIf="joinRequests.length > 0" class="card join-requests-card">
        <div class="card-header bg-primary-red text-white">
          Join Requests
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered table-sm m-0">
              <thead class="bg-light">
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let req of joinRequests">
                <td>{{ req.userDisplayName || req.userId }}</td>
                <td>{{ req.userEmail }}</td>
                <td>
                  <button class="btn btn-success btn-sm me-1" (click)="handleJoinRequest(req, true)">
                    <i class="fa fa-check"></i> Accept
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="handleJoinRequest(req, false)">
                    <i class="fa fa-times"></i> Deny
                  </button>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="league-manage-right">
      <div class="card league-players-card mb-4">
        <div class="card-header bg-primary-red text-white">
          Players in League
        </div>
        <div class="card-body p-0">
          <div *ngIf="loadingPlayers" class="text-center my-4">
            <div class="spinner-border text-primary" role="status"></div>
          </div>
          <div *ngIf="!loadingPlayers && leaguePlayers.length > 0">
            <div class="table-responsive">
              <table class="table table-bordered table-sm m-0">
                <thead class="bg-light">
                <tr>
                  <th>Display Name</th>
                  <th>Email</th>
                  <th>Country</th>
                  <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let player of leaguePlayers">
                  <td>{{ player.displayName || '-' }}</td>
                  <td>{{ player.email }}</td>
                  <td>{{ player.countryName || '-' }}</td>
                  <td>
                    <button
                      class="btn btn-outline-danger btn-sm"
                      (click)="onKickPlayer(player)"
                      [disabled]="player.id === league?.owner?.id"
                      title="Kick from league"
                    >
                      <i class="fa-solid fa-user-slash"></i> Kick
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
            <!-- Pagination -->
            <nav *ngIf="playersTotal > playersPageSize" class="mt-3">
              <ul class="pagination justify-content-center">
                <li class="page-item" [class.disabled]="playersPageNum === 1">
                  <button class="page-link" (click)="onPlayersPageChange(playersPageNum - 1)" [disabled]="playersPageNum === 1">Previous</button>
                </li>
                <li class="page-item disabled">
                  <span class="page-link">Page {{ playersPageNum }}</span>
                </li>
                <li class="page-item" [class.disabled]="playersPageNum * playersPageSize >= playersTotal">
                  <button class="page-link" (click)="onPlayersPageChange(playersPageNum + 1)" [disabled]="playersPageNum * playersPageSize >= playersTotal">Next</button>
                </li>
              </ul>
            </nav>
          </div>
          <div *ngIf="!loadingPlayers && leaguePlayers.length === 0" class="alert alert-info m-3">
            No players in this league.
          </div>
        </div>
      </div>
    </div>

    <app-confirm-modal
      [show]="showDeleteConfirm"
      title="Confirm Deletion"
      [message]="'Are you sure you want to delete the league ' + (league?.name || '') + '? This action cannot be undone.'"
      confirmText="Delete"
      cancelText="Cancel"
      confirmIcon="fa-solid fa-trash"
      [loading]="deleting"
      (confirm)="onDeleteLeague()"
      (cancel)="showDeleteConfirm = false"
    ></app-confirm-modal>
  </div>
</app-content-container>
